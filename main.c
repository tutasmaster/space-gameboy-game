
#include <gb/gb.h>
#include <rand.h>
#include "tileset.c"
#include "bg.c"
#include "sprites.c"
#include "tesko.c"
#include "title.c"

void init();
void checkInput();
void updateSwitches();
void prepareGame();

UINT8 collisionCheck(UINT8, UINT8, UINT8, UINT8, UINT8, UINT8, UINT8, UINT8);

UINT8 blankScreen[] =
{
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

void main() {

	init();
	
	while(1) {
		
		checkInput();				// Check for user input (and act on it)
		updateSwitches();			// Make sure the SHOW_SPRITES and SHOW_BKG switches are on each loop
		wait_vbl_done();			// Wait until VBLANK to avoid corrupting memory
	}
	
}

UINT8 y;

UINT8 i = 0x0;

UINT8 asteroids[] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

UINT8 paused = 0x1;
UINT8 joy = 0x0;
UINT8 speed = 0x1;
UINT16 score = 0x0;
extern UINT16 best;

UINT8 gamestate = 0x0;

void init() {
	set_bkg_tiles(0,0,20,18,blankScreen);
	ENABLE_RAM_MBC1;
	if(best == 0xFFFF)
		best = 0;
	DISPLAY_ON;						// Turn on the display
	set_bkg_data(0, 82, TileLabel);		// Load 47 tiles into background memory

	set_bkg_tiles(7,3,4,5,teskobg);
	
	set_bkg_tiles(0,10,20,1,title);

}

void prepareGame(){
	NR52_REG = 0x80;
	NR51_REG = 0x11;
	NR50_REG = 0x77;

	NR10_REG = 0xE9;
	NR11_REG = 0x10;
	NR12_REG = 0x83;
	NR13_REG = 0x00;
	NR14_REG = 0x87;
	
	set_bkg_tiles(0,0,20,18,blankScreen);
	
	set_sprite_data(0,5,sprites);

    set_sprite_tile(0,0);
    set_sprite_tile(1,1);
    set_sprite_tile(2,2);
    set_sprite_tile(3,3);
    set_sprite_tile(4,4);
    set_sprite_tile(5,1);
    set_sprite_tile(6,2);
    set_sprite_tile(7,3);
    set_sprite_tile(8,4);

    do{
        asteroids[i*2] = (i*24) + 100;
        asteroids[(i*2)+1] = (rand() % 4) + 1;
    }while(i++ <7);

    y = 1;
}

void updateSwitches() {
	
	HIDE_WIN;
	SHOW_SPRITES;
	SHOW_BKG;
	
}

void checkInput() {
	if(gamestate == 0x0){
		if(joypad() & J_START){
			gamestate = 0x1;
			prepareGame();
		}
	}else if(gamestate == 0x1){
		if(joy != joypad() && joypad() & J_START){
			if(paused == 0x0)
				paused = 0x1;
			else
				paused = 0x0;
		}
		
		if(paused == 0x0){
			score += 1;
		}
		
		if(best < score){
			best = score;
		}
		
		// DOWN
		if(paused == 0x0){
			if (joy != joypad() && joypad() & J_DOWN) {
				y++;
			}
			
			if (joy != joypad() && joypad() & J_UP) {
				y--;
			}
			
			if (joypad() & J_SELECT){
				best = 0;
				gamestate = 0x2;
			} 
		}

		joy = joypad();

		if(y > 4){
			y = 4;
		}

		if(y < 1){
			y = 1;
		}

		i = 0x0;
		do{
			if(paused == 0x0){
					asteroids[i*2] -= speed;
				if(collisionCheck(16,y*24,8,8,asteroids[(i*2)],asteroids[(i*2)+1]*24,8,8) == 1){
					score = 0;
					NR52_REG = 0x80;
					NR51_REG = 0x11;
					NR50_REG = 0x77;

					NR10_REG = 0x9E;
					NR11_REG = 0x10;
					NR12_REG = 0xF3;
					NR13_REG = 0x00;
					NR14_REG = 0x87;
					gamestate = 0x2;
				}			
			}			
			move_sprite(i+1,asteroids[i*2],asteroids[(i*2)+1]*24);

			if(asteroids[i*2] < 1){
				asteroids[(i*2)+1] = (rand()%4)+1;
				asteroids[(i*2)] = 152;
			}
			
		}while(i++ < 7);

		move_sprite(0,16,(y*24));
		
		speed = (score/300)+1;
		
		bg[9] = (score%10)+1;
		bg[8] = ((score%100)/10)+1;
		bg[7] = ((score%1000)/100)+1;
		bg[6] = ((score%10000)/1000)+1;
		
		bg[19] = (best%10)+1;
		bg[18] = ((best%100)/10)+1;
		bg[17] = ((best%1000)/100)+1;
		bg[16] = ((best%10000)/1000)+1;
		
		set_bkg_tiles(0,13,bgWidth,bgHeight,bg);
	}else if(gamestate == 0x2){
		i = 0;
		score = 0;
		do{
			asteroids[i*2] = (i*16) + 100;
			asteroids[(i*2)+1] = (rand() % 4) + 1;
		}while(i++ <7);
		y = 1;
		gamestate = 0x1;
		paused = 0x1;
	}
    
}

UINT8 collisionCheck(UINT8 x1, UINT8 y1, UINT8 w1, UINT8 h1, UINT8 x2, UINT8 y2, UINT8 w2, UINT8 h2) {
	if ((x1 < (x2+w2)) && ((x1+w1) > x2) && (y1 < (h2+y2)) && ((y1+h1) > y2)) {
		return 1;
	} else {
		return 0;
	}
}